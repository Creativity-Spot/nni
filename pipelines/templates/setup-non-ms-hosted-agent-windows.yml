# Windows version of set-up a clean virtual machine for pipeline.

steps:

# Install azcopy for cache download.

- powershell: |
    New-Item -ItemType Directory -Force -Path $(Agent.ToolsDirectory)\azcopy
    Invoke-WebRequest -Uri "https://aka.ms/downloadazcopy-v10-windows" -OutFile "$(Agent.ToolsDirectory)\azcopy\azcopy.zip"
    Expand-Archive -Force "$(Agent.ToolsDirectory)\azcopy\azcopy.zip" -DestinationPath "$(Agent.ToolsDirectory)\azcopy"
    Copy-Item "$(Agent.ToolsDirectory)\azcopy\azcopy*\*" -Destination "$(Agent.ToolsDirectory)\azcopy"
    Write-Host "##vso[task.prependpath]$(Agent.ToolsDirectory)\azcopy"
  displayName: Setup azcopy


# UsePythonVersion task only works when the specific Python version is already installed.

# The following is for linux.
# Reference: https://stackoverflow.com/questions/60936103/install-python-to-self-hosted-windows-build-agent
# We only need Python 3.9 on Windows.

- powershell: |
    Invoke-WebRequest -Uri "https://www.python.org/ftp/python/3.9.12/python-3.9.12-amd64.exe" -OutFile "python-installer.exe"
    Get-ChildItem C:\
    Get-Date
    $process = Start-Process -FilePath .\python-installer.exe -PassThru -NoNewWindow -Wait -ArgumentList "/quiet TargetDir=C:\Python Include_launcher=0"
    $process
    Get-ChildItem C:\
    Get-Date
    Start-Sleep -Seconds 60
    Get-ChildItem C:\a\
    Start-Process -FilePath .\python-installer.exe -NoNewWindow -Wait -ArgumentList "/quiet TargetDir=$(Agent.ToolsDirectory)\Python\3.9.12\x64 Include_launcher=0"
    New-Item -Path $(Agent.ToolsDirectory)\Python\3.9.12\x64.complete -ItemType file -Force
    Get-ChildItem $(Agent.ToolsDirectory)\Python\3.9.12
    Get-ChildItem $(Agent.ToolsDirectory)\Python\3.9.12\x64
  displayName: Install Python 3.9
