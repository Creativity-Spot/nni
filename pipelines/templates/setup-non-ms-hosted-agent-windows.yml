# Windows version of set-up a clean virtual machine for pipeline.

steps:

# Package manager.

- powershell: |
    $env:path.Split(";")
  displayName: Display all environment variables


# Install azcopy for cache download.

- powershell: |
    New-Item -ItemType Directory -Force -Path $(Agent.ToolsDirectory)\azcopy
    Invoke-WebRequest -Uri "https://aka.ms/downloadazcopy-v10-windows" -OutFile "$(Agent.ToolsDirectory)\azcopy\azcopy.zip"
    Expand-Archive "$(Agent.ToolsDirectory)\azcopy\azcopy.zip" -DestinationPath "$(Agent.ToolsDirectory)\azcopy"
    Remove-Item "$(Agent.ToolsDirectory)\azcopy\azcopy.zip"
    Get-ChildItem "$(Agent.ToolsDirectory)\azcopy"
    Write-Host "##vso[task.prependpath]$(Agent.ToolsDirectory)\azcopy"
  displayName: Setup azcopy

- powershell: |
    $env:path.Split(";")
    azcopy.exe --version
  displayName: Check azcopy

# UsePythonVersion task only works when the specific Python version is already installed.

# The following is for linux.
# Reference: https://dev.to/akaszynski/create-an-azure-self-hosted-agent-without-going-insane-173g
# We only need Python 3.7 and 3.9 for now.
# --system-site-packages is required to make packages installed with --user visible to virtualenv.
- script: |
    set -e
    sudo add-apt-repository ppa:deadsnakes/ppa
    sudo apt install -y python3.7-dev python3.7-venv python3.9-dev python3.9-venv
    mkdir $(Agent.ToolsDirectory)/Python
  displayName: Download Python

- script: |
    set -e
    cd $(Agent.ToolsDirectory)/Python
    PY37_VER=$(python3.7 -c "import sys; print('.'.join([f'{val}' for val in sys.version_info[:3]]))")
    mkdir $PY37_VER
    ln -s $PY37_VER 3.7
    cd $PY37_VER
    python3.7 -m venv x64 --system-site-packages
    touch x64.complete
  displayName: Configure Python 3.7

- script: |
    set -e
    cd $(Agent.ToolsDirectory)/Python
    PY39_VER=$(python3.9 -c "import sys; print('.'.join([f'{val}' for val in sys.version_info[:3]]))")
    mkdir $PY39_VER
    ln -s $PY39_VER 3.9
    cd $PY39_VER
    python3.9 -m venv x64 --system-site-packages
    touch x64.complete
  displayName: Configure Python 3.9
